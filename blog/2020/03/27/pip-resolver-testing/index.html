<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Testing the next-gen pip dependency resolver | Pradyun Gedam</title><meta name=keywords content="pip,dependency resolver,testing"><meta name=description content="This is an attempt to summarize the broader software architecture around dependency resolution in pip and how testing is being done around this area.
The motivation behind writing this, is to make sure all the developers working on this project are on the same page, and to have a written record about the state of affairs.
Architecture The &ldquo;legacy&rdquo; resolver in pip, is implemented as part of pip&rsquo;s codebase and has been a part of it for many years."><meta name=author content><link rel=canonical href=https://pradyunsg.me/blog/2020/03/27/pip-resolver-testing/><link crossorigin=anonymous href=/assets/css/stylesheet.min.3d6bc2d744e85e443ce9e0035c0912877057e2f80577fe9ec24a45db5580cbf3.css integrity="sha256-PWvC10ToXkQ86eADXAkSh3BX4vgFd/6ewkpF21WAy/M=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://pradyunsg.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://pradyunsg.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://pradyunsg.me/favicon-32x32.png><link rel=apple-touch-icon href=https://pradyunsg.me/apple-touch-icon.png><link rel=mask-icon href=https://pradyunsg.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.82.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Testing the next-gen pip dependency resolver"><meta property="og:description" content="This is an attempt to summarize the broader software architecture around dependency resolution in pip and how testing is being done around this area.
The motivation behind writing this, is to make sure all the developers working on this project are on the same page, and to have a written record about the state of affairs.
Architecture The &ldquo;legacy&rdquo; resolver in pip, is implemented as part of pip&rsquo;s codebase and has been a part of it for many years."><meta property="og:type" content="article"><meta property="og:url" content="https://pradyunsg.me/blog/2020/03/27/pip-resolver-testing/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-03-27T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Testing the next-gen pip dependency resolver"><meta name=twitter:description content="This is an attempt to summarize the broader software architecture around dependency resolution in pip and how testing is being done around this area.
The motivation behind writing this, is to make sure all the developers working on this project are on the same page, and to have a written record about the state of affairs.
Architecture The &ldquo;legacy&rdquo; resolver in pip, is implemented as part of pip&rsquo;s codebase and has been a part of it for many years."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Scribbled Notes","item":"https://pradyunsg.me/blog/"},{"@type":"ListItem","position":2,"name":"Testing the next-gen pip dependency resolver","item":"https://pradyunsg.me/blog/2020/03/27/pip-resolver-testing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing the next-gen pip dependency resolver","name":"Testing the next-gen pip dependency resolver","description":"This is an attempt to summarize the broader software architecture around dependency resolution in pip and how testing is being done around this area.\nThe motivation behind writing this, is to make sure all the developers working on this project are on the same page, and to have a written record about the state of affairs.\nArchitecture The \u0026ldquo;legacy\u0026rdquo; resolver in pip, is implemented as part of pip\u0026rsquo;s codebase and has been a part of it for many years.","keywords":["pip","dependency resolver","testing"],"articleBody":"This is an attempt to summarize the broader software architecture around dependency resolution in pip and how testing is being done around this area.\nThe motivation behind writing this, is to make sure all the developers working on this project are on the same page, and to have a written record about the state of affairs.\nArchitecture The “legacy” resolver in pip, is implemented as part of pip’s codebase and has been a part of it for many years. It’s very tightly coupled with the existing code, isn’t easy to work with and has severe backward compatibility concerns with modifying directly – which is why we’re implementing a separate “new” resolver in this project, instead of trying to improve the existing one.\nThe “new” resolver that is under development, is not implemented as part of pip’s codebase; not completely anyway. We’re using an abstraction that separates all the metadata-generation-and-handling stuff vs the core algorithm. This allows us to work on the core algorithm logic (i.e. the NP-hard search problem) separately from pip-specific logic (eg. download, building etc). The abstraction and core algorithm are written/maintained in https://github.com/sarugaku/resolvelib right now. The pip-specific logic for implementing the “other side” of the abstraction is in https://github.com/pypa/pip/tree/master/src/pip/_internal/resolution/resolvelib.\nTesting In terms of testing, we have dependency-resolution-related tests in both resolvelib and pip.\nresolvelib The tests in resolvelib are intended more as “check if the algorithm does things correctly” and even contains tests that are agnostic to the Python ecosystem (eg. we’ve borrowed tests from Ruby, Swift etc). The goal here is to make sure that the core algorithm we implement is capable of generating correct answers (for example: not getting stuck in looping on the same “requirement”, not revisiting rejected nodes etc).\npip The tests in pip is where I’ll start needing more words to explain what’s happening. :)\nYAML-based tests We have “YAML” tests which I’d written back in 2017, as a format to easily write tests for pip’s new resolver when we implement it. However, since we didn’t have a need for it to be working completely back then (there wasn’t a new resolver to test with it!), the “harness” for running these tests isn’t complete and would likely need some work to be as feature complete as we’d want it to be, for writing good tests.\nYAML tests: https://github.com/pypa/pip/tree/master/tests/yaml\nYAML test “harness”: https://github.com/pypa/pip/blob/master/tests/functional/test_yaml.py and https://github.com/pypa/pip/blob/master/tests/lib/yaml_helpers.py\n“new” resolver tests unit tests We have some unit tests for the new resolver implementation. These cover very basic “sanity checks” to ensure it follows the “contract” of the abstraction, like “do the candidates returned by a requirement actually satisfy that requirement?”. These likely don’t need to be touched, since they’re fairly well scoped and test fairly low-level details (i.e. ideal for unit tests).\nNew resolver unit tests: https://github.com/pypa/pip/tree/master/tests/unit/resolution_resolvelib\nfunctional tests We also have “new resolver functional tests”, which are written as part of the current work. These exist since how-to-work-with-YAML-tests was not an easy question to answer and there needs to be work done (both on the YAML format, as well as the YAML test harness) to flag which tests should run with which resolver (both, only legacy, only new) and make it possible to put run these tests in CI easily.\nNew resolver functional tests: https://github.com/pypa/pip/blob/master/tests/functional/test_new_resolver.py\ntest_install*.py These files test all the functionality of the install command (like: does it use the right build dependencies, does it download the correct files, does it write the correct metadata etc). There might be some dependency-resolution-related tests in test_install*.py files.\nThese files contain a lot of tests so, ideally, at some point, someone would go through and de-duplicate tests from this as well.\nHow can you help? If you use pip, there are a multiple ways that you can help us!\n  First and most fundamentally, please help us understand how you use pip by talking with our user experience researchers. You can do this right now! You can take a survey, or have a researcher interview you over a video call. Please sign up and spread the word to anyone who uses pip (even a little bit).\n  Right now, even before we release the new resolver as a beta, you can help by running pip check on your current environment. This will report if you have any inconsistencies in your set of installed packages. Having a clean installation will make it much less likely that you will hit issues when the new resolver is released (and may address hidden problems in your current environment!). If you run pip check and run into stuff you can’t figure out, please ask for help in our issue tracker or chat.\n   Thanks to Paul Moore and Tzu-Ping for help in reviewing and writing this post, as well as Sumana Harihareswara for suggesting to put this up on my blog!\n","wordCount":"796","inLanguage":"en","datePublished":"2020-03-27T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://pradyunsg.me/blog/2020/03/27/pip-resolver-testing/"},"publisher":{"@type":"Organization","name":"Pradyun Gedam","logo":{"@type":"ImageObject","url":"https://pradyunsg.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://pradyunsg.me/ accesskey=h title="Pradyun Gedam (Alt + H)">Pradyun Gedam</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://pradyunsg.me/about/ title=about><span>about</span></a></li><li><a href=https://pradyunsg.me/blog/ title=Blog><span>blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Testing the next-gen pip dependency resolver</h1><div class=post-meta>March 27, 2020&nbsp;·&nbsp;4 minutes</div></header><div class=post-content><p>This is an attempt to summarize the broader software architecture around dependency resolution in pip and how testing is being done around this area.</p><p>The motivation behind writing this, is to make sure all the developers working on this project are on the same page, and to have a written record about the state of affairs.</p><h2 id=architecture>Architecture<a hidden class=anchor aria-hidden=true href=#architecture>#</a></h2><p>The &ldquo;legacy&rdquo; resolver in pip, is implemented as part of pip&rsquo;s codebase and has been a part of it for many years. It&rsquo;s very tightly coupled with the existing code, isn&rsquo;t easy to work with and has severe backward compatibility concerns with modifying directly &ndash; which is why we&rsquo;re implementing a separate &ldquo;new&rdquo; resolver in this project, instead of trying to improve the existing one.</p><p>The &ldquo;new&rdquo; resolver that is under development, is not implemented as part of pip&rsquo;s codebase; not completely anyway. We&rsquo;re using an abstraction that separates all the metadata-generation-and-handling stuff vs the core algorithm. This allows us to work on the core algorithm logic (i.e. the NP-hard search problem) separately from pip-specific logic (eg. download, building etc). The abstraction and core algorithm are written/maintained in <a href=https://github.com/sarugaku/resolvelib>https://github.com/sarugaku/resolvelib</a> right now. The pip-specific logic for implementing the &ldquo;other side&rdquo; of the abstraction is in <a href=https://github.com/pypa/pip/tree/master/src/pip/_internal/resolution/resolvelib>https://github.com/pypa/pip/tree/master/src/pip/_internal/resolution/resolvelib</a>.</p><h2 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h2><p>In terms of testing, we have dependency-resolution-related tests in both resolvelib and pip.</p><h3 id=resolvelib>resolvelib<a hidden class=anchor aria-hidden=true href=#resolvelib>#</a></h3><p>The tests in resolvelib are intended more as &ldquo;check if the algorithm does things correctly&rdquo; and even contains tests that are agnostic to the Python ecosystem (eg. we&rsquo;ve borrowed tests from Ruby, Swift etc). The goal here is to make sure that the core algorithm we implement is capable of generating correct answers (for example: not getting stuck in looping on the same &ldquo;requirement&rdquo;, not revisiting rejected nodes etc).</p><h3 id=pip>pip<a hidden class=anchor aria-hidden=true href=#pip>#</a></h3><p>The tests in pip is where I&rsquo;ll start needing more words to explain what&rsquo;s happening. :)</p><h4 id=yaml-based-tests>YAML-based tests<a hidden class=anchor aria-hidden=true href=#yaml-based-tests>#</a></h4><p>We have &ldquo;YAML&rdquo; tests which I&rsquo;d written back in 2017, as a format to easily write tests for pip&rsquo;s new resolver when we implement it. However, since we didn&rsquo;t have a need for it to be working completely back then (there wasn&rsquo;t a new resolver to test with it!), the &ldquo;harness&rdquo; for running these tests isn&rsquo;t complete and would likely need some work to be as feature complete as we&rsquo;d want it to be, for writing good tests.</p><p>YAML tests: <a href=https://github.com/pypa/pip/tree/master/tests/yaml>https://github.com/pypa/pip/tree/master/tests/yaml</a><br>YAML test &ldquo;harness&rdquo;: <a href=https://github.com/pypa/pip/blob/master/tests/functional/test_yaml.py>https://github.com/pypa/pip/blob/master/tests/functional/test_yaml.py</a> and <a href=https://github.com/pypa/pip/blob/master/tests/lib/yaml_helpers.py>https://github.com/pypa/pip/blob/master/tests/lib/yaml_helpers.py</a></p><h4 id=new-resolver-tests>&ldquo;new&rdquo; resolver tests<a hidden class=anchor aria-hidden=true href=#new-resolver-tests>#</a></h4><h5 id=unit-tests>unit tests<a hidden class=anchor aria-hidden=true href=#unit-tests>#</a></h5><p>We have some unit tests for the new resolver implementation. These cover very basic &ldquo;sanity checks&rdquo; to ensure it follows the &ldquo;contract&rdquo; of the abstraction, like &ldquo;do the candidates returned by a requirement actually satisfy that requirement?&rdquo;. These likely don&rsquo;t need to be touched, since they&rsquo;re fairly well scoped and test fairly low-level details (i.e. ideal for unit tests).</p><p>New resolver unit tests: <a href=https://github.com/pypa/pip/tree/master/tests/unit/resolution_resolvelib>https://github.com/pypa/pip/tree/master/tests/unit/resolution_resolvelib</a></p><h5 id=functional-tests>functional tests<a hidden class=anchor aria-hidden=true href=#functional-tests>#</a></h5><p>We also have &ldquo;new resolver functional tests&rdquo;, which are written as part of the current work. These exist since how-to-work-with-YAML-tests was not an easy question to answer and there needs to be work done (both on the YAML format, as well as the YAML test harness) to flag which tests should run with which resolver (both, only legacy, only new) and make it possible to put run these tests in CI easily.</p><p>New resolver functional tests: <a href=https://github.com/pypa/pip/blob/master/tests/functional/test_new_resolver.py>https://github.com/pypa/pip/blob/master/tests/functional/test_new_resolver.py</a></p><h4 id=test_installpy>test_install*.py<a hidden class=anchor aria-hidden=true href=#test_installpy>#</a></h4><p>These files test all the functionality of the install command (like: does it use the right build dependencies, does it download the correct files, does it write the correct metadata etc). There might be some dependency-resolution-related tests in <code>test_install*.py</code> files.</p><p>These files contain a lot of tests so, ideally, at some point, someone would go through and de-duplicate tests from this as well.</p><h2 id=how-can-you-help>How can you help?<a hidden class=anchor aria-hidden=true href=#how-can-you-help>#</a></h2><p>If you use pip, there are a multiple ways that you can help us!</p><ul><li><p>First and most fundamentally, <a href=https://bit.ly/pip-ux-studies>please help us understand how you use pip by <strong>talking with our user experience researchers</strong></a>. You can do this right now! You can take a survey, or have a researcher interview you over a video call. <a href=https://bit.ly/pip-ux-studies>Please sign up and spread the word</a> to anyone who uses pip (even a little bit).</p></li><li><p>Right now, even before we release the new resolver as a beta, you can help by <strong>running <code>pip check</code> on your current environment</strong>. This will report if you have any inconsistencies in your set of installed packages. Having a clean installation will make it much less likely that you will hit issues when the new resolver is released (and may address hidden problems in your current environment!). If you run <code>pip check</code> and run into stuff you can’t figure out, please <a href=https://pip.pypa.io/>ask for help in our issue tracker or chat</a>.</p></li></ul><hr><p>Thanks to Paul Moore and Tzu-Ping for help in reviewing and writing this post,
as well as Sumana Harihareswara for suggesting to put this up on my blog!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://pradyunsg.me/tags/pip/>pip</a></li><li><a href=https://pradyunsg.me/tags/dependency-resolver/>dependency resolver</a></li><li><a href=https://pradyunsg.me/tags/testing/>testing</a></li></ul><nav class=paginav><a class=prev href=https://pradyunsg.me/blog/2020/12/08/catchup/><span class=title>« Newer</span><br><span>Catching up</span></a>
<a class=next href=https://pradyunsg.me/blog/2020/02/19/oss-update-8/><span class=title>Older »</span><br><span>OSS Work update #8</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://pradyunsg.me/>Pradyun Gedam</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
with tweaks.</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>